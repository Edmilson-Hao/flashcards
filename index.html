<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards Ebbinghaus</title>
    <!-- Carrega o Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuração de fontes e estilos base do Tailwind -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .flashcard-flip {
            transform-style: preserve-3d;
            transition: transform 0.6s;
            cursor: pointer;
        }
        .flashcard-flip.is-flipped {
            transform: rotateY(180deg);
        }
        .flashcard-face {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            background-color: white;
        }
        .flashcard-back {
            transform: rotateY(180deg);
            background-color: #e2e8f0; /* Slightly darker back */
        }
        .notification {
            transition: background-color 0.3s ease-in-out;
        }
        .correct-bg {
            background-color: #d1fae5; /* Green 100 */
        }
        .incorrect-bg {
            background-color: #fee2e2; /* Red 100 */
        }
        /* Estilos específicos das imagens */
        .w-66vw {
            width: 66vw;
        }
        .h-80vh {
            height: 80vh;
        }
    </style>
</head>
<body class="notification min-h-screen flex flex-col">

    <!-- Container Principal da Aplicação -->
    <div id="app-container" class="flex flex-col flex-grow items-center justify-center p-4">
        <!-- Todas as telas (views) serão controladas pelo JavaScript -->

        <!-- 1. Tela de Login -->
        <div id="view-login" class="view">
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full text-center">
                <h1 class="text-3xl font-bold text-gray-800 mb-6">Bem-Vindo ao Flashcards!</h1>
                <p class="text-gray-600 mb-8">Faça login para começar a gerenciar seus flashcards.</p>
                <button id="btn-login-google" class="w-full flex items-center justify-center bg-blue-600 text-white font-semibold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 shadow-md">
                    <svg class="w-5 h-5 mr-3" fill="currentColor" viewBox="0 0 48 48">
                        <path d="M24 9.5c3.2 0 5.8 1.1 7.7 2.9l5.1-5.1C33.7 3.5 29.2 1 24 1 15.6 1 8.5 5.5 4.7 12.3l6.5 5c1.7-5.1 6.6-8.8 12.8-8.8z" fill="#EA4335"/><path d="M46.7 24.5c0-1.7-.1-3.3-.4-4.9H24v9.2h12.5c-.6 3.1-2.4 5.7-4.9 7.5l6.7 5.2c4.1-3.8 6.5-9.3 6.5-15.5z" fill="#4285F4"/><path d="M10.2 29.7c-.5-1.5-.7-3.1-.7-4.7s.2-3.2.7-4.7l-6.5-5.1C3.4 17.5 3 20.9 3 24.5s.4 7 1.2 10.3l6-5.1z" fill="#FBBC05"/><path d="M24 47.9c6.4 0 11.9-2.1 15.9-5.7l-6.7-5.2c-2.3 1.5-5.2 2.4-9.2 2.4-6.2 0-11.2-4-13.1-9.5l-6.5 5.1c3.8 6.8 11.1 11.3 18.5 11.3z" fill="#34A853"/>
                    </svg>
                    Entrar com Google
                </button>
                <div id="login-message" class="mt-4 text-sm text-red-500 hidden"></div>
            </div>
        </div>

        <!-- 2. Tela Home (Menu) -->
        <div id="view-home" class="view hidden w-full h-full flex flex-col items-center justify-center p-4">
            <h1 class="text-4xl font-extrabold text-gray-900 mb-10">FLASH CARDS</h1>

            <!-- Layout conforme imagem: 66vw de largura e alinhamento vertical/horizontal -->
            <div class="flex flex-col space-y-4 items-center w-full max-w-xl md:w-66vw" style="max-height: 80vh;">
                <button id="btn-home-adicionar" class="w-full bg-indigo-600 text-white text-xl font-bold py-4 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-lg">
                    Adicionar Cards
                </button>
                <button id="btn-home-revisar" class="w-full bg-green-600 text-white text-xl font-bold py-4 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg">
                    Revisar
                </button>
                <button id="btn-home-biblioteca" class="w-full bg-teal-600 text-white text-xl font-bold py-4 rounded-lg hover:bg-teal-700 transition duration-300 shadow-lg">
                    Biblioteca
                </button>
            </div>

            <!-- Informação do Usuário (Rodapé/Cantoneira) -->
            <div class="fixed bottom-4 right-4 bg-white p-3 rounded-lg shadow-xl text-sm text-gray-700">
                Usuário: <span id="user-display">Carregando...</span> (<span id="user-id-display">...</span>)
                <button id="btn-logout" class="ml-3 text-red-500 hover:text-red-700 font-medium">Sair</button>
            </div>
        </div>

        <!-- 3. Tela de Adicionar Cards (Sub-menu) -->
        <div id="view-add-menu" class="view hidden w-full flex flex-col items-center justify-center p-4">
            <h1 class="text-3xl font-bold text-gray-800 mb-10">ADICIONAR CARDS</h1>
            <div class="flex flex-col space-y-6 w-full max-w-lg">
                <button id="btn-add-manual" class="w-full bg-indigo-500 text-white text-lg font-semibold py-4 rounded-lg hover:bg-indigo-600 transition duration-300 shadow-lg">
                    Manual (Individualmente)
                </button>
                <button id="btn-add-automatico" class="w-full bg-purple-500 text-white text-lg font-semibold py-4 rounded-lg hover:bg-purple-600 transition duration-300 shadow-lg">
                    Automático (JSON em Massa)
                </button>
            </div>
            <button id="btn-back-from-add-menu" class="mt-8 text-gray-500 hover:text-gray-700 font-medium">← Voltar para Home</button>
        </div>

        <!-- 3a. Div Adicionar Manual -->
        <div id="view-add-manual" class="view hidden w-full max-w-2xl bg-white p-8 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Cadastro Manual de Flashcard</h2>
            <form id="form-add-manual" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">Idioma do Card</label>
                    <input type="text" id="manual-idioma" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Palavra / Frase</label>
                    <input type="text" id="manual-palavra" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Tradução</label>
                    <input type="text" id="manual-traducao" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">Exemplos de Uso (Separe com ponto e vírgula ';')</label>
                    <textarea id="manual-exemplos" rows="4" required class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border"></textarea>
                </div>
                <button type="submit" class="w-full bg-green-500 text-white font-semibold py-3 rounded-lg hover:bg-green-600 transition duration-300">
                    Salvar Card
                </button>
            </form>
            <div id="manual-message" class="mt-4 text-center font-medium"></div>
            <button id="btn-back-from-manual" class="mt-6 text-gray-500 hover:text-gray-700 font-medium">← Voltar</button>
        </div>

        <!-- 3b. Div Adicionar Automático (JSON) -->
        <div id="view-add-automatico" class="view hidden w-full max-w-2xl bg-white p-8 rounded-xl shadow-2xl">
            <h2 class="text-2xl font-bold text-gray-800 mb-6">Cadastro Automático (JSON)</h2>
            <p class="text-gray-600 mb-4">Cole o array JSON de flashcards no formato abaixo:</p>
            <pre class="bg-gray-100 p-3 rounded-md text-sm text-gray-700 mb-4 overflow-auto">
[
  {
    "idioma": "Inglês",
    "palavra": "Ephemeral",
    "traducao": "Efêmero",
    "exemplos": [
      "The beauty of a sunset is ephemeral.",
      "Ephemeral trends come and go quickly.",
      "His fame proved to be an ephemeral thing.",
      "We enjoyed the ephemeral pleasure of the picnic."
    ]
  },
  // ... mais cards
]
            </pre>
            <textarea id="automatico-json-input" rows="10" placeholder='Cole seu JSON aqui...' class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-3 border"></textarea>
            <button id="btn-processar-json" class="w-full mt-4 bg-purple-600 text-white font-semibold py-3 rounded-lg hover:bg-purple-700 transition duration-300">
                Processar e Salvar Cards
            </button>
            <div id="automatico-message" class="mt-4 text-center font-medium"></div>
            <button id="btn-back-from-automatico" class="mt-6 text-gray-500 hover:text-gray-700 font-medium">← Voltar</button>
        </div>

        <!-- 4. Tela de Revisão -->
        <div id="view-revisao" class="view hidden w-full flex flex-col items-center p-4">
            <h1 class="text-3xl font-bold text-gray-800 mb-6">REVISÃO DE FLASHCARDS</h1>

            <div id="flashcard-area" class="w-full max-w-xl md:max-w-md h-80 relative mb-8">
                <!-- O Flashcard principal -->
                <div id="flashcard-container" class="flashcard-flip w-full h-full">

                    <!-- Frente do Card (Palavra/Frase) -->
                    <div id="card-front" class="flashcard-face bg-white border-2 border-indigo-500">
                        <span id="card-idioma-front" class="absolute top-4 left-4 text-sm font-semibold text-indigo-600 bg-indigo-100 px-2 py-1 rounded-full">Idioma</span>
                        <p id="card-palavra-front" class="text-4xl font-extrabold text-gray-900 text-center"></p>
                    </div>

                    <!-- Verso do Card (Tradução e Detalhes) -->
                    <div id="card-back" class="flashcard-face flashcard-back bg-gray-100 border-2 border-indigo-500">
                        <p class="text-xl font-bold text-gray-700 mb-2">Tradução:</p>
                        <p id="card-traducao-back" class="text-3xl font-extrabold text-indigo-700 text-center mb-6"></p>
                        <p class="text-lg font-bold text-gray-700 mb-2">Exemplos de Uso:</p>
                        <ul id="card-exemplos-back" class="list-disc list-inside text-left text-sm text-gray-600 w-full px-4 space-y-1">
                            <!-- Exemplos serão inseridos aqui -->
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Controles de Revisão -->
            <div id="review-controls" class="w-full max-w-xl md:max-w-md">

                <!-- Modo Múltipla Escolha -->
                <div id="quiz-options-container" class="space-y-3">
                    <button class="quiz-option-btn w-full bg-gray-50 text-gray-800 font-semibold py-3 px-4 rounded-lg border-2 border-gray-200 hover:bg-indigo-50 transition duration-150 shadow-md text-left" data-index="0"></button>
                    <button class="quiz-option-btn w-full bg-gray-50 text-gray-800 font-semibold py-3 px-4 rounded-lg border-2 border-gray-200 hover:bg-indigo-50 transition duration-150 shadow-md text-left" data-index="1"></button>
                    <button class="quiz-option-btn w-full bg-gray-50 text-gray-800 font-semibold py-3 px-4 rounded-lg border-2 border-gray-200 hover:bg-indigo-50 transition duration-150 shadow-md text-left" data-index="2"></button>
                    <button class="quiz-option-btn w-full bg-gray-50 text-gray-800 font-semibold py-3 px-4 rounded-lg border-2 border-gray-200 hover:bg-indigo-50 transition duration-150 shadow-md text-left" data-index="3"></button>
                </div>

                <!-- Modo Digitação (Opcional) -->
                <div id="quiz-typing-container" class="hidden space-y-3">
                    <input type="text" id="typing-input" placeholder="Digite a tradução..." class="w-full rounded-lg border-2 border-gray-300 p-3 shadow-md focus:border-indigo-500 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                    <button id="typing-submit-btn" class="w-full bg-blue-500 text-white font-semibold py-3 rounded-lg hover:bg-blue-600 transition duration-300">
                        Verificar
                    </button>
                    <p id="typing-message" class="text-center mt-2 text-sm font-medium"></p>
                </div>

                <!-- Botões de Ação Após Revelar -->
                <div id="review-result-controls" class="hidden flex justify-center space-x-4 mt-4">
                    <button id="btn-next-card" class="bg-indigo-500 text-white font-semibold py-2 px-6 rounded-lg hover:bg-indigo-600 transition duration-300">Próximo Card</button>
                </div>

                <p id="revisao-message" class="text-center mt-4 text-sm text-gray-600">Carregando cards para revisão...</p>

            </div>

            <button id="btn-back-from-revisao" class="mt-8 text-gray-500 hover:text-gray-700 font-medium">← Voltar para Home</button>
        </div>

        <!-- 5. Tela de Biblioteca (Arquivo) -->
        <div id="view-biblioteca" class="view hidden w-full p-4">
            <h1 class="text-3xl font-bold text-gray-800 mb-6 text-center">BIBLIOTECA DE FLASHCARDS</h1>

            <div class="overflow-x-auto bg-white rounded-xl shadow-2xl p-4">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">#</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Idioma</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Palavra / Frase</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nível Ebbinghaus</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Próxima Revisão</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                        </tr>
                    </thead>
                    <tbody id="biblioteca-table-body" class="bg-white divide-y divide-gray-200">
                        <!-- Linhas da tabela serão inseridas aqui -->
                    </tbody>
                </table>
                <p id="biblioteca-message" class="text-center p-4 text-gray-500">Carregando dados...</p>
            </div>

            <button id="btn-back-from-biblioteca" class="mt-8 text-gray-500 hover:text-gray-700 font-medium">← Voltar para Home</button>
        </div>

    </div>

    <!-- Script de Inicialização e Funções Firebase/App -->
    <script type="module">
        // #################################################################
        // ################ CONFIGURAÇÃO E AUTENTICAÇÃO FIREBASE ###########
        // #################################################################

        // Importa as funções necessárias do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signInWithCustomToken, signInAnonymously, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, query, orderBy, getDocs, addDoc, deleteDoc, Timestamp, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variáveis globais de ambiente (fornecidas pelo Canvas)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyA_R9qLO_Cj-b2mLGPPQFZPearLS8_ZL78",
            authDomain: "flashcards-6cc04.firebaseapp.com",
            projectId: "flashcards-6cc04",
            storageBucket: "flashcards-6cc04.firebasestorage.app",
            messagingSenderId: "689024752336",
            appId: "1:689024752336:web:1235587e239187a0ab9cd5",
        };
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // Inicializa o Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        setLogLevel('Debug'); // Habilita logs para depuração

        let currentUserId = null;
        let userDataRef = null; // Referência ao documento do usuário (Coleção)

        // Estrutura de repetição espaçada (Curva de Ebbinghaus simplificada)
        // Intervalos em dias para cada nível (Nível 0 = 0 dias, Nível 1 = 1 dia, Nível 2 = 2 dias, etc.)
        const EBBINGHAUS_INTERVALS_DAYS = [0, 1, 2, 4, 7, 15, 30, 90, 180, 365];

        /**
         * Gera a próxima data de revisão com base no nível atual.
         * @param {number} currentLevel Nível atual (0 a N)
         * @returns {Date} A próxima data de revisão.
         */
        function getNextReviewDate(currentLevel) {
            const level = Math.min(currentLevel, EBBINGHAUS_INTERVALS_DAYS.length - 1);
            const days = EBBINGHAUS_INTERVALS_DAYS[level];
            const nextDate = new Date();
            nextDate.setDate(nextDate.getDate() + days);
            return nextDate;
        }

        /**
         * Autentica o usuário usando o token customizado ou anonimamente.
         */
        async function authenticateUser() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                    console.log("Login com token customizado concluído.");
                } else {
                    await signInAnonymously(auth);
                    console.log("Login anônimo concluído.");
                }
            } catch (error) {
                console.error("Erro na autenticação inicial:", error);
            }
        }

        // Observador de estado de autenticação
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                // Define o caminho para os dados do usuário
                // Coleção: /artifacts/{appId}/users/{userId}/flashcards/data
                const userFlashcardPath = `/artifacts/${appId}/users/${currentUserId}/flashcards`;
                userDataRef = doc(db, userFlashcardPath, "data");

                // Atualiza a exibição do usuário
                document.getElementById('user-display').textContent = user.displayName || 'Anônimo';
                document.getElementById('user-id-display').textContent = currentUserId;

                // Tenta carregar os dados/coleção do usuário ou inicializa
                loadUserDataAndNavigate();

            } else {
                currentUserId = null;
                // Exibe a tela de login
                showView('view-login');
            }
        });

        /**
         * Tenta carregar os dados/coleção do usuário ou inicializa.
         */
        async function loadUserDataAndNavigate() {
            try {
                const docSnap = await getDoc(userDataRef);

                if (docSnap.exists()) {
                    console.log("Dados do usuário carregados:", docSnap.data());
                } else {
                    // Inicializa a coleção/documento do usuário
                    const initialData = {
                        name: auth.currentUser.displayName || 'Usuário Anônimo',
                        email: auth.currentUser.email || 'N/A',
                        createdAt: Timestamp.now(),
                    };
                    await setDoc(userDataRef, initialData);
                    console.log("Documento de usuário inicializado.");
                }

                // Inicia o listener de flashcards e navega para a home
                setupFlashcardsListener();
                showView('view-home');

            } catch (error) {
                console.error("Erro ao carregar ou inicializar dados do usuário:", error);
                // Em caso de erro, força o logout para recarregar
                await signOut(auth);
            }
        }

        // #################################################################
        // ################### CONTROLE DE VISUALIZAÇÃO ####################
        // #################################################################

        const views = document.querySelectorAll('.view');
        /**
         * Mostra uma view específica e esconde todas as outras.
         * @param {string} viewId O ID da view a ser exibida (ex: 'view-login').
         */
        function showView(viewId) {
            views.forEach(view => {
                view.classList.add('hidden');
            });
            document.getElementById(viewId).classList.remove('hidden');
            // Remove as classes de feedback de fundo ao mudar de tela
            document.body.classList.remove('correct-bg', 'incorrect-bg');
            if (viewId === 'view-revisao') {
                loadFlashcardForReview();
            }
            if (viewId === 'view-biblioteca') {
                renderBiblioteca();
            }
        }

        // #################################################################
        // ##################### GERENCIAMENTO DE CARDS ####################
        // #################################################################

        let allFlashcards = [];
        let flashcardsCollectionRef = null;

        /**
         * Configura o listener em tempo real para todos os flashcards do usuário.
         */
        function setupFlashcardsListener() {
            if (!currentUserId) return;

            // Coleção: /artifacts/{appId}/users/{userId}/flashcards/cards
            const cardsPath = `/artifacts/${appId}/users/${currentUserId}/flashcards/cards`;
            flashcardsCollectionRef = collection(db, cardsPath);

            // onSnapshot para ouvir alterações em tempo real
            onSnapshot(flashcardsCollectionRef, (snapshot) => {
                allFlashcards = [];
                snapshot.forEach(doc => {
                    const card = doc.data();
                    card.id = doc.id;
                    // Certifica-se de que a data de revisão é um objeto Date
                    if (card.nextReview instanceof Timestamp) {
                        card.nextReview = card.nextReview.toDate();
                    }
                    allFlashcards.push(card);
                });
                console.log(`Total de Flashcards carregados: ${allFlashcards.length}`);

                // Se a view de biblioteca estiver aberta, renderiza novamente
                if (!document.getElementById('view-biblioteca').classList.contains('hidden')) {
                    renderBiblioteca();
                }
            }, (error) => {
                console.error("Erro ao ouvir a coleção de flashcards:", error);
                document.getElementById('biblioteca-message').textContent = 'Erro ao carregar os dados.';
            });
        }

        /**
         * Salva um novo flashcard no Firestore.
         * @param {object} cardData Dados do flashcard (idioma, palavra, traducao, exemplos).
         */
        async function saveFlashcard(cardData) {
            if (!flashcardsCollectionRef) {
                console.error("Coleção de flashcards não inicializada.");
                return;
            }

            // Inicializa o card com nível 0 e data de revisão imediata
            const newCard = {
                ...cardData,
                reviewLevel: 0, // Nível inicial
                nextReview: Timestamp.fromDate(getNextReviewDate(0)), // Revisão imediata
                createdAt: Timestamp.now(),
            };

            try {
                await addDoc(flashcardsCollectionRef, newCard);
                return true;
            } catch (error) {
                console.error("Erro ao salvar o flashcard:", error);
                return false;
            }
        }

        // #################################################################
        // ################### LÓGICA DE REVISÃO (EBBINGHAUS) ##############
        // #################################################################

        let cardsToReview = [];
        let currentCard = null;
        let isCardFlipped = false;
        let correctAnswer = ''; // A tradução correta
        let allPossibleAnswers = []; // Todas as opções para o quiz

        /**
         * Carrega o próximo flashcard para revisão.
         */
        function loadFlashcardForReview() {
            if (allFlashcards.length === 0) {
                document.getElementById('revisao-message').textContent = 'Você não tem nenhum card cadastrado.';
                return;
            }

            // 1. Filtra cards prontos para revisão (nextReview <= agora)
            const now = new Date();
            cardsToReview = allFlashcards
                .filter(card => card.nextReview <= now)
                .sort((a, b) => a.nextReview - b.nextReview); // Ordena pelo mais urgente

            if (cardsToReview.length === 0) {
                document.getElementById('revisao-message').textContent = 'Parabéns! Você revisou todos os cards por hoje. Volte mais tarde.';
                return;
            }

            // 2. Seleciona o card mais urgente
            currentCard = cardsToReview[0];
            document.getElementById('revisao-message').textContent = `${cardsToReview.length} card(s) pendente(s) para revisão.`;

            // 3. Reseta o estado do card
            isCardFlipped = false;
            document.getElementById('flashcard-container').classList.remove('is-flipped');
            document.body.classList.remove('correct-bg', 'incorrect-bg');
            document.getElementById('review-result-controls').classList.add('hidden');
            document.getElementById('typing-message').textContent = '';

            // 4. Preenche a interface
            correctAnswer = currentCard.traducao;

            // Frente do Card
            document.getElementById('card-idioma-front').textContent = currentCard.idioma;
            document.getElementById('card-palavra-front').textContent = currentCard.palavra;

            // Verso do Card
            document.getElementById('card-traducao-back').textContent = currentCard.traducao;
            const exemplosList = document.getElementById('card-exemplos-back');
            exemplosList.innerHTML = '';
            // Os 4 exemplos de uso são exibidos, mesmo que o usuário não erre
            (Array.isArray(currentCard.exemplos) ? currentCard.exemplos : []).forEach(ex => {
                const li = document.createElement('li');
                li.textContent = ex;
                exemplosList.appendChild(li);
            });


            // 5. Determina o modo de revisão (Quiz ou Digitação)
            // Se o nível de revisão for alto (ex: >= 3), usa digitação para maior desafio.
            const useTypingMode = currentCard.reviewLevel >= 3;

            if (useTypingMode) {
                // Modo Digitação
                document.getElementById('quiz-options-container').classList.add('hidden');
                document.getElementById('quiz-typing-container').classList.remove('hidden');
                document.getElementById('typing-input').value = ''; // Limpa o input
            } else {
                // Modo Múltipla Escolha
                document.getElementById('quiz-options-container').classList.remove('hidden');
                document.getElementById('quiz-typing-container').classList.add('hidden');
                setupQuizOptions();
            }
        }

        /**
         * Monta as opções de múltipla escolha.
         */
        function setupQuizOptions() {
            // Seleciona 3 traduções incorretas de outros flashcards (do mesmo idioma, se possível)
            const incorrectOptions = allFlashcards
                .filter(card => card.id !== currentCard.id)
                .map(card => card.traducao);

            // Garante 3 opções de distração, se houver cards suficientes
            const shuffledIncorrect = shuffleArray(incorrectOptions).slice(0, 3);
            allPossibleAnswers = shuffleArray([correctAnswer, ...shuffledIncorrect]);

            // Garante que sempre haverá 4 opções
            while (allPossibleAnswers.length < 4) {
                allPossibleAnswers.push("Opção Falsa " + (Math.random() * 100).toFixed(0));
            }
            allPossibleAnswers = allPossibleAnswers.slice(0, 4); // Limita a 4 opções

            const optionButtons = document.querySelectorAll('.quiz-option-btn');
            optionButtons.forEach((btn, index) => {
                btn.textContent = allPossibleAnswers[index];
                btn.disabled = false;
                btn.classList.remove('bg-green-100', 'bg-red-100', 'border-green-500', 'border-red-500');
                btn.classList.add('bg-gray-50', 'border-gray-200');
            });
        }

        /**
         * Inverte o card para mostrar a tradução e os detalhes.
         * @param {boolean} isCorrect Indica se o usuário acertou ou errou.
         */
        function flipCard(isCorrect) {
            if (isCardFlipped) return;
            isCardFlipped = true;
            document.getElementById('flashcard-container').classList.add('is-flipped');

            // Feedback visual (tela brilha)
            document.body.classList.add(isCorrect ? 'correct-bg' : 'incorrect-bg');
            document.body.classList.remove(isCorrect ? 'incorrect-bg' : 'correct-bg');

            // Esconde as opções do quiz/digitação e mostra o botão "Próximo Card"
            document.getElementById('quiz-options-container').classList.add('hidden');
            document.getElementById('quiz-typing-container').classList.add('hidden');
            document.getElementById('review-result-controls').classList.remove('hidden');
        }

        /**
         * Atualiza o nível de revisão do flashcard.
         * @param {boolean} isCorrect Se o usuário acertou o card.
         */
        async function updateCardReviewStatus(isCorrect) {
            if (!currentCard || !flashcardsCollectionRef) return;

            // Calcula o novo nível e a próxima data de revisão
            let newLevel = currentCard.reviewLevel;
            if (isCorrect) {
                newLevel = Math.min(newLevel + 1, EBBINGHAUS_INTERVALS_DAYS.length - 1);
            } else {
                newLevel = Math.max(0, newLevel - 1); // Volta um nível ou reinicia
            }

            const nextReviewDate = getNextReviewDate(newLevel);

            try {
                const cardRef = doc(flashcardsCollectionRef, currentCard.id);
                await updateDoc(cardRef, {
                    reviewLevel: newLevel,
                    nextReview: Timestamp.fromDate(nextReviewDate),
                    lastReviewed: Timestamp.now(),
                    // Opcional: manter um contador de acertos/erros
                    totalReviews: (currentCard.totalReviews || 0) + 1,
                    correctCount: (currentCard.correctCount || 0) + (isCorrect ? 1 : 0),
                });
                console.log(`Card ${currentCard.id} atualizado. Nível: ${newLevel}, Próxima Revisão: ${nextReviewDate.toLocaleDateString()}`);
            } catch (error) {
                console.error("Erro ao atualizar o status de revisão:", error);
            }
        }

        // #################################################################
        // ################### LÓGICA DA BIBLIOTECA ########################
        // #################################################################

        /**
         * Renderiza a lista de todos os flashcards na view Biblioteca.
         */
        function renderBiblioteca() {
            const tbody = document.getElementById('biblioteca-table-body');
            const message = document.getElementById('biblioteca-message');
            tbody.innerHTML = '';

            if (allFlashcards.length === 0) {
                message.textContent = 'Nenhum flashcard cadastrado ainda.';
                message.classList.remove('hidden');
                return;
            }

            message.classList.add('hidden');

            // Ordena em ordem alfabética pela palavra/frase
            const sortedCards = [...allFlashcards].sort((a, b) => a.palavra.localeCompare(b.palavra));

            sortedCards.forEach((card, index) => {
                const tr = document.createElement('tr');
                tr.classList.add('hover:bg-gray-50');

                // Determina o status/cor do nível
                const levelText = `Nível ${card.reviewLevel}`;
                let levelColor = 'text-gray-700';
                if (card.reviewLevel >= 5) levelColor = 'text-green-600 font-bold';
                else if (card.reviewLevel >= 2) levelColor = 'text-blue-600';
                else levelColor = 'text-red-600';

                // Próxima Revisão formatada
                const nextReviewDate = card.nextReview instanceof Date ? card.nextReview.toLocaleDateString() : 'N/A';

                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${index + 1}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-700">${card.idioma}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-indigo-600">${card.palavra}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm ${levelColor}">${levelText}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${nextReviewDate}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <button data-card-id="${card.id}" class="btn-delete-card text-red-500 hover:text-red-700">Excluir</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });

            // Adiciona o evento de clique para exclusão
            document.querySelectorAll('.btn-delete-card').forEach(button => {
                button.onclick = (e) => deleteCard(e.target.dataset.cardId);
            });
        }

        /**
         * Exclui um flashcard do Firestore.
         * @param {string} cardId O ID do documento a ser excluído.
         */
        async function deleteCard(cardId) {
            if (!confirm("Tem certeza de que deseja excluir este flashcard?")) return; // Usando confirm provisoriamente, idealmente seria um modal customizado

            if (!flashcardsCollectionRef) return;
            try {
                const cardRef = doc(flashcardsCollectionRef, cardId);
                await deleteDoc(cardRef);
                console.log(`Card ${cardId} excluído com sucesso.`);
            } catch (error) {
                console.error("Erro ao excluir o card:", error);
            }
        }


        // #################################################################
        // ########################## UTILIDADES ###########################
        // #################################################################

        /**
         * Embaralha um array usando o algoritmo Fisher-Yates.
         * @param {Array} array O array a ser embaralhado.
         * @returns {Array} O array embaralhado.
         */
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }


        // #################################################################
        // ##################### EVENT LISTENERS ###########################
        // #################################################################

        // 1. LOGIN
        document.getElementById('btn-login-google').addEventListener('click', async () => {
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                console.log("Login com Google bem-sucedido:", result.user);
                // onAuthStateChanged cuidará da navegação
            } catch (error) {
                const errorMessage = error.message.includes('popup-closed-by-user') ?
                    'Login cancelado pelo usuário.' :
                    `Erro ao fazer login: ${error.code}`;
                document.getElementById('login-message').textContent = errorMessage;
                document.getElementById('login-message').classList.remove('hidden');
                console.error("Erro de login:", error);
            }
        });

        document.getElementById('btn-logout').addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Erro ao fazer logout:", error);
            }
        });

        // 2. HOME (NAVEGAÇÃO)
        document.getElementById('btn-home-adicionar').addEventListener('click', () => showView('view-add-menu'));
        document.getElementById('btn-home-revisar').addEventListener('click', () => showView('view-revisao'));
        document.getElementById('btn-home-biblioteca').addEventListener('click', () => showView('view-biblioteca'));

        // 3. ADICIONAR CARDS (SUB-MENU)
        document.getElementById('btn-add-manual').addEventListener('click', () => showView('view-add-manual'));
        document.getElementById('btn-add-automatico').addEventListener('click', () => showView('view-add-automatico'));
        document.getElementById('btn-back-from-add-menu').addEventListener('click', () => showView('view-home'));

        // 3a. ADICIONAR MANUAL
        document.getElementById('btn-back-from-manual').addEventListener('click', () => showView('view-add-menu'));

        document.getElementById('form-add-manual').addEventListener('submit', async (e) => {
            e.preventDefault();
            const idioma = document.getElementById('manual-idioma').value.trim();
            const palavra = document.getElementById('manual-palavra').value.trim();
            const traducao = document.getElementById('manual-traducao').value.trim();
            const exemplosStr = document.getElementById('manual-exemplos').value.trim();

            const exemplos = exemplosStr.split(';').map(ex => ex.trim()).filter(ex => ex.length > 0);

            if (!idioma || !palavra || !traducao || exemplos.length === 0) {
                document.getElementById('manual-message').textContent = 'Preencha todos os campos obrigatórios.';
                document.getElementById('manual-message').classList.add('text-red-500');
                return;
            }

            const cardData = { idioma, palavra, traducao, exemplos };
            const success = await saveFlashcard(cardData);
            const messageEl = document.getElementById('manual-message');

            if (success) {
                messageEl.textContent = 'Flashcard salvo com sucesso!';
                messageEl.classList.add('text-green-500');
                messageEl.classList.remove('text-red-500');
                // Limpa o formulário após o sucesso
                document.getElementById('form-add-manual').reset();
            } else {
                messageEl.textContent = 'Erro ao salvar o flashcard. Tente novamente.';
                messageEl.classList.add('text-red-500');
                messageEl.classList.remove('text-green-500');
            }
        });

        // 3b. ADICIONAR AUTOMÁTICO
        document.getElementById('btn-back-from-automatico').addEventListener('click', () => showView('view-add-menu'));

        document.getElementById('btn-processar-json').addEventListener('click', async () => {
            const jsonInput = document.getElementById('automatico-json-input').value.trim();
            const messageEl = document.getElementById('automatico-message');
            messageEl.textContent = '';
            messageEl.classList.remove('text-red-500', 'text-green-500');

            if (!jsonInput) {
                messageEl.textContent = 'Cole o JSON antes de processar.';
                messageEl.classList.add('text-red-500');
                return;
            }

            try {
                const cardsArray = JSON.parse(jsonInput);
                if (!Array.isArray(cardsArray)) {
                    throw new Error("O conteúdo deve ser um array JSON.");
                }

                let savedCount = 0;
                for (const card of cardsArray) {
                    if (card.idioma && card.palavra && card.traducao && Array.isArray(card.exemplos) && card.exemplos.length > 0) {
                        const cardData = {
                            idioma: card.idioma,
                            palavra: card.palavra,
                            traducao: card.traducao,
                            exemplos: card.exemplos,
                        };
                        const success = await saveFlashcard(cardData);
                        if (success) savedCount++;
                    } else {
                        console.warn("Card JSON inválido ignorado:", card);
                    }
                }

                document.getElementById('automatico-json-input').value = ''; // Limpa a área de texto
                messageEl.textContent = `${savedCount} card(s) salvo(s) com sucesso! ${cardsArray.length - savedCount} card(s) ignorado(s) por serem inválidos.`;
                messageEl.classList.add('text-green-500');

            } catch (error) {
                messageEl.textContent = `Erro ao processar JSON: ${error.message}`;
                messageEl.classList.add('text-red-500');
                console.error("Erro ao processar JSON:", error);
            }
        });

        // 4. REVISÃO (QUIZ/TYPING)
        document.getElementById('btn-back-from-revisao').addEventListener('click', () => showView('view-home'));

        // Múltipla Escolha
        document.querySelectorAll('.quiz-option-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                if (isCardFlipped || !currentCard) return;

                const selectedAnswer = e.target.textContent;
                const isCorrect = selectedAnswer === correctAnswer;

                // Destaca a opção correta e incorreta
                document.querySelectorAll('.quiz-option-btn').forEach(btn => {
                    btn.disabled = true;
                    if (btn.textContent === correctAnswer) {
                        btn.classList.add('bg-green-100', 'border-green-500');
                        btn.classList.remove('bg-gray-50', 'border-gray-200');
                    } else if (btn.textContent === selectedAnswer) {
                        btn.classList.add('bg-red-100', 'border-red-500');
                        btn.classList.remove('bg-gray-50', 'border-gray-200');
                    }
                });

                // Inverte o card e atualiza o status de revisão
                flipCard(isCorrect);
                updateCardReviewStatus(isCorrect);
            });
        });

        // Digitação
        document.getElementById('typing-submit-btn').addEventListener('click', () => {
            if (isCardFlipped || !currentCard) return;

            const typedAnswer = document.getElementById('typing-input').value.trim();
            const isCorrect = typedAnswer.toLowerCase() === correctAnswer.toLowerCase();
            const messageEl = document.getElementById('typing-message');

            if (!typedAnswer) {
                messageEl.textContent = "Digite algo para verificar.";
                messageEl.classList.add('text-red-500');
                return;
            }

            messageEl.classList.remove('text-red-500');
            messageEl.textContent = isCorrect ? "Correto!" : `Incorreto. A tradução correta é: "${correctAnswer}"`;
            messageEl.classList.add(isCorrect ? 'text-green-600' : 'text-red-600');

            // Inverte o card e atualiza o status de revisão
            flipCard(isCorrect);
            updateCardReviewStatus(isCorrect);
        });

        // Próximo Card (após flip)
        document.getElementById('btn-next-card').addEventListener('click', () => {
            loadFlashcardForReview();
        });


        // 5. BIBLIOTECA
        document.getElementById('btn-back-from-biblioteca').addEventListener('click', () => showView('view-home'));


        // #################################################################
        // ################## INICIALIZAÇÃO DA APLICAÇÃO ###################
        // #################################################################

        // Tenta autenticar ao carregar a página
        authenticateUser();

    </script>
</body>
</html>